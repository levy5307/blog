---
layout: post
title: 2pc
date: 2021-07-11
Author: levy5307
tags: [分布式事务]
comments: true
toc: true
---

在分布式系统中，不能简单的向所有节点发送提交请求，然后各个节点去独立的执行事务提交。例如：

- 某些节点检测到违反约束或者冲突因而决定终止，而其他节点则可能成功提交

- 发送给某些节点的提交请求可能因为网络原因丢失，而发往其他节点的请求则顺利通过

- 某些节点可能在日志记录写入之前发生崩溃，然后再恢复时回滚，而其他节点成功提交

因为部分节点提交成功、而其他一些节点提交失败的情况，将会破坏原子性。

之前的[文章](https://levy5307.github.io/blog/distributed-transaction/)讲到过，分布式事务的原子性是由2pc来保证的。

## 2pc的基本流程

2pc全称two-phase commit，即两阶段提交，它将事务的提交分为两个阶段。

阶段1：协调者（即事务管理器）发送prepare request至所有的参与者。询问其是否可提交，并跟踪参与者的回应。

在这个阶段，需检查是否存在违反约束或者冲突，当参与者回复yes之前，并要确保任何情况都可以提交，这是***参与者所作出的承诺***。

阶段2：协调者获取到所有参与者的回答后，根据具体情况判断提交与否：

- 如果所有参与者回复yes，表示他们已经准备好提交，则协调者会发出提交请求给参与者，进行实际的提交。

- 如果有至少一个参与者回复no，表示该参与者无法正确提交，协调者就会向参与者发送放弃请求。

在这个阶段中，协调者根据所有参与者的回复获取最终的事务提交与否的决定，并需要将最终的决定落盘。这个时刻称为提交点。在落盘之后，需要向所有参与者发送提交请求，即使发生了超时等失败，也要一直重试直到成功。这是***协调者所作出的承诺***。

***这里协调者和参与者的两个承诺是不可撤销的，必须严格贯彻。也正是这两个承诺才保证了2pc的原子性***。
