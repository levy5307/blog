---
layout: post
title: Anna
date: 2021-08-21
Author: levy5307
tags: [论文]
comments: true
toc: true
---

## 设计目标

在现在KV存储系统中，有些设计成全球范围内分布式的，有些设计成单机的。然而在近些年都逐渐收敛到云上。基于这个背景设计了一个可以在任何scale上都运行的很好的KV系统。针对该KV系统有四个设计需求：

- partition。为了实现data scaling当然需要partition。但是Anna实现partition不仅需要云上跨机器的，也需要跨cpu核以提供更高性能。

- multi-master replication。为了实现workload scaling，需要实现multi-master replication使用多线程来同时响应读写请求。

- wait-free execution。为了更大化使用多核机器的硬件使用率和性能，需要实现wait-free execution。这意味着每个线程都是在做有意义的工作，而无需等待其他线程。

- coordination-free一致性模型。为了支持更广范围的应用，需要实现一个广泛范围的coordinator-free一致性模型。

这篇论文描述了Anna的设计和实现，***其通过采用lattice + Actor model的方式：***

- lattice主要用于实现最终一致性

- Actor Model主要用于避免同步，从而减少了同步开销。

## Lattice

如果要实现最终一致性，需要满足以下几个条件：

- 结合律：a + b + c = a + (b + c)

- 交换律：a + b = b + a

- 幂等律：a + a = a

如果满足了以上三点，就可以克服异步网络造成的丢包、乱序等问题，从而实现副本间的最终一致性。lattice就是这样一种数据结构。 

## Limitations of shared-memory

大多数multi-core kv系统使用共享内存将整个存储状态在多线程间共享：每个线程都可以进行读或者写。这需要对读和写操作进行同步以防止冲突产生。同步可以通过有锁或者无锁的方式来实现，然而不管是否有锁都会有性能开销。latice并没有改变上述情况，如果使用了共享内存，一样会有相应的同步开销。

***通过采用Actor Model，可以避免采用shared-memory，从而节省了同步开销***。Anna论文里讲到，Masstree仅仅使用了4%~5%的CPU时间在请求处理上，而Anna由于避免了同步开销可以达到90%左右。

## Message-passing

message-passing结构由一系列的actor组成，每个actor运行在一个单独的cpu核上。每个actor维护自己的状态且其他actor不可访问。actor运行一个loop，循环从input queue中获取客户端的请求以及其他核发来的消息进行处理。由于每个actor只会处理自己的local state，所以避免了共享内存，因此也避免了同步操作

message-passing有两种管理key的选择：single-master和multi-master replication。

- single-master replication。在该模式下，每个key都会指派给一个单独的actor。这防止了对一个key的同时修改，因此而保证了一致性。但是这将一个key的更新频率限制在了单个actor的更新频率。

- multi-master replication。一个key会被复制到多个actor，每个actor读取或者更新其本地副本。这也分为两种：

1. coordination。当更新一个key时，actors可以参与协调控制，使得update按照一个全局的顺序，尽管多个actor可以处理updates，然而全局有序的广播使得每个actor都将这些update按照相同的顺序进行处理，当然，同步操作发生在请求处理的关键路径上，会影响性能。

2. coordination-free。每个actor在本地处理请求，并且不会引入inter-actor communication。所有update的communication在timer被触发、或者actor的请求负载减少的情况下进行。

coordination-free multi-master模式性能最高，但是由于副本将会以不同的顺序处理请求，会导致副本间的不一致。***前面已经讲到，借助lattice可以避免不一致的情况***

## Anna architecture

![](../images/Anna-arch.jpg)

上图所示为单个机器上的Anna的架构。

- 每个核绑定了一个线程，用于运行coordination-free actor。线程数不会超过CPU核数，以免线程切换带来的性能损耗。

- 用户通过Client Proxy与Anna相连，Client Proxy负责在不同的server、以及同一个server间不同核上的load balance。

- 线程间的通信通过内存中的Multicast Buffer，避免使用共享内存等同步机制。而server间的通信通过Network Multicast

